# 곡선 최적화 경로 로직 요구사항

## 기본 원칙
직선 최적화 경로 로직을 기반으로 하되, 직선/곡선을 구분하여 곡선 구간은 부드러운 호(arc)로 처리한다.

---

## 1단계: Keypoint 추출 (직선 로직과 동일)
- 직선 로직의 `extract_keypoints()` 함수 사용
- 네이버 Directions 15 API의 원본 경로(예: 11개 포인트)에서 주요 지점만 추출 (예: 5~7개)
- 각도 임계값 기준으로 방향이 크게 바뀌는 지점만 keypoint로 선정

---

## 2단계: Keypoint 간 직선/곡선 판단
각 keypoint 쌍 (A → B)에 대해:

### 직선 판단 기준:
- keypoint A와 B를 잇는 직선과 그 사이 원본 경로 포인트들의 최대 편차가 작음 (예: < 5cm)
- 또는 두 keypoint 사이 각도 변화가 작음 (예: < 15°)

### 곡선 판단 기준:
- 위 직선 기준을 만족하지 않으면 곡선으로 판단

---

## 3단계: 곡선 구간 처리

### 직선 구간:
- keypoint A → B로 단순 직진 명령 생성
- 회전 각도 + 직진 거리

### 곡선 구간:
1. **최외곽 점 찾기:**
   - keypoint A와 B 사이의 원본 경로 포인트들 중
   - A-B를 잇는 직선으로부터 **가장 멀리 떨어진 점 C**를 찾음

2. **3점 곡선 생성:**
   - A, C, B 세 점을 지나는 곡선(호) 생성
   - 이 곡선은 `smooth_curve` 타입으로 처리
   - 선속도(linear) + 각속도(angular)를 동시에 적용하여 호를 그리며 이동

---

## 4단계: 로봇 명령 생성

### 세그먼트 타입
- **직선 구간:** `{"type": "straight", "linear": 0.1, "angular": 0.0, ...}`
- **곡선 구간:** `{"type": "smooth_curve", "linear": 0.1, "angular": 0.0 or ±X, ...}`

### 회전 처리 규칙 (angular 값 결정)

**핵심 규칙: 곡선→곡선만 스무스 회전, 나머지는 정지→회전→이동**

| 이전 세그먼트 | 현재 세그먼트 | angular 값 | 로봇 동작 |
|--------------|--------------|-----------|---------|
| 직선 | 직선 | `0.0` | 정지 → 회전(`turn_angle`) → 직진 |
| 직선 | 곡선 | `0.0` | 정지 → 회전(`turn_angle`) → 곡선 이동 |
| 곡선 | 직선 | `0.0` | 정지 → 회전(`turn_angle`) → 직진 |
| 곡선 | 곡선 | `-radians(turn_angle)/duration` | 스무스 회전하며 이동 ✨ |
| 없음(첫 세그먼트) | 직선/곡선 | `0.0` | 회전 없이 이동 시작 |

**설명:**
- `angular = 0.0`: `execute_path()`에서 `rotate(turn_angle)` 먼저 실행 → 정지 후 회전
- `angular ≠ 0.0`: `move_curve()`에서 선속도와 각속도를 동시 적용 → 스무스 회전

**임계값:**
- 직선 판단: 최대 편차 < **2.75m** (차로 폭 기준)
- 곡선 판단: 최대 편차 ≥ 2.75m

---

## 예시
**원본 경로:** 1 → 2 → 3 → 4 → 5 → 6 → 7 → 8 → 9 → 10 → 11 (11개 포인트)

**Keypoint 추출 후:** 1, 4, 7, 10, 11 (5개)

**경로 생성:**
1. **1 → 4 구간:** 직선 판단 → 1개 직진 명령
2. **4 → 7 구간:** 직선 판단 → 1개 직진 명령  
3. **7 → 10 구간:** 곡선 판단 → 7-10 사이 최외곽 점 찾기 (예: 포인트 8) → 7, 8, 10을 지나는 곡선 → 1개 곡선 명령
4. **10 → 11 구간:** 곡선 판단 → 최외곽 점 없음 → 3점 보간 → 1개 곡선 명령

**결과:** 총 4~5개 명령 (직선 로직과 비슷한 수)

---

## 핵심 차이점
- **직선 로직:** keypoint 간 모두 직선으로 처리 (회전 → 직진)
- **곡선 로직:** keypoint 간 직선/곡선 판단 → 곡선은 호(arc)로 처리 (선속도 + 각속도 동시 적용)

---

## 금지사항
- ❌ 원본 경로의 모든 포인트를 개별 세그먼트로 만들지 말 것
- ❌ keypoint 추출 없이 전체 경로를 세세하게 나누지 말 것
- ❌ 직선 구간을 여러 개로 쪼개지 말 것

---

## 구현 파일
- **메인 로직:** `robot_ws/src/move_turtle/api_to_position_curve.py`
- **직선 로직 (참고):** `robot_ws/src/move_turtle/api_to_position.py`
- **대시보드:** `robot_ws/src/move_turtle/dashboard/dashboard.py`

---

## 참고사항
- 이 로직은 직선 로직의 스케일 계산 방식을 그대로 따름 (bbox 기반 `scale_factor`)
- `original_distance`는 `haversine_distance`로 실제 지구 표면 거리를 계산
- 곡선 명령 실행 시 `move_curve()` 메서드 사용 (선속도 + 각속도 동시 적용)

